<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Stock Alerts — Serverless</title>
  <link rel="manifest" href="./manifest.webmanifest"/>
  <meta name="theme-color" content="#111111"/>
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="StockAlerts">
  <style>
    body{font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial;margin:0}
    .grid{display:grid;grid-template-columns:300px 1fr;min-height:100vh}
    aside{border-right:1px solid #eee;padding:14px}
    main{padding:14px}
    .btn{padding:10px 12px;border-radius:10px;border:1px solid #111;background:#111;color:#fff;cursor:pointer}
    .btn2{padding:8px 10px;border-radius:8px;border:1px solid #ddd;background:#fff;cursor:pointer}
    .input{border:1px solid #ddd;border-radius:8px;padding:10px 12px;width:100%}
    .input-sm{border:1px solid #ddd;border-radius:8px;padding:6px 8px;width:100%}
    .card{background:#fff;border:1px solid #eee;border-radius:12px;padding:8px}
    .tape span{padding:6px 8px;border:1px solid #eee;border-radius:8px;margin-right:8px;display:inline-block;margin-bottom:8px}
    @media (max-width:900px){.grid{grid-template-columns:1fr}aside{border-right:none;border-bottom:1px solid #eee}}
  </style>
  <script src="https://unpkg.com/lightweight-charts@4.2.2/dist/lightweight-charts.standalone.production.js"></script>
</head>
<body>
  <div class="grid">
    <aside>
      <h2 style="margin:0">Watchlist</h2>
      <div id="watchlist"></div>

      <div style="display:grid;gap:8px;margin-top:10px">
        <input id="addTicker" class="input" placeholder="Add ticker (AAPL)"/>
        <button id="btnAdd" class="btn2">Add</button>
      </div>

      <hr style="margin:14px 0">

      <h3 style="margin:0">Settings</h3>
      <label style="display:block;font-size:12px;margin-top:6px">Finnhub API Token</label>
      <input id="apiToken" class="input" placeholder="Paste your Finnhub token"/>
      <small>Get one free at finnhub.io → API Key. Token is saved only on this device.</small>
      <div style="display:flex;gap:8px;margin-top:8px">
        <button id="saveToken" class="btn2">Save</button>
        <button id="testConn" class="btn2">Test connection</button>
      </div>

      <div style="margin-top:12px">
        <label>Timeframe</label>
        <select id="tf" class="input">
          <option>1m</option><option>5m</option><option>15m</option><option>1h</option><option>1D</option>
        </select>
      </div>
      <div style="margin-top:8px">
        <label>Chart Type</label>
        <select id="ctype" class="input-sm">
          <option value="standard">Standard</option>
          <option value="heikin">Heikin-Ashi</option>
        </select>
      </div>

      <hr style="margin:14px 0">
      <h3 style="margin:0">Alert</h3>
      <div style="display:grid;gap:8px;margin-top:8px">
        <input id="alertPrice" class="input" placeholder="Target price (e.g. 200)"/>
        <select id="alertDir" class="input-sm"><option value="above">Above</option><option value="below">Below</option></select>
        <button id="btnAlert" class="btn">Create alert for selected</button>
        <small id="alertMsg" style="color:#333"></small>
      </div>
    </aside>

    <main>
      <header style="display:flex;align-items:baseline;gap:12px">
        <h1 id="title" style="margin:0">—</h1>
        <div id="price" style="font-size:18px">—</div>
      </header>

      <section class="card" style="margin-top:12px">
        <div id="chart" style="width:100%;height:420px"></div>
      </section>

      <section style="margin-top:14px">
        <h3 style="margin:0 0 8px">Live Ticker Tape</h3>
        <div id="tape" class="tape"></div>
      </section>
    </main>
  </div>

<script>
/* -------- App state -------- */
const state = {
  token: localStorage.getItem('finnhub_token') || '',
  watchlist: JSON.parse(localStorage.getItem('watchlist')||'["AAPL","MSFT","NVDA","TSLA"]'),
  sel: localStorage.getItem('selected') || 'AAPL',
  tf: localStorage.getItem('tf') || '1m',
  ctype: localStorage.getItem('ctype') || 'standard',
  prices: {},
  ws: null,
  subs: new Set(),
  alerts: JSON.parse(localStorage.getItem('alerts')||'[]'), // [{t,p,d}]
};

/* -------- DOM refs -------- */
const elWatch = document.getElementById('watchlist');
const elAdd = document.getElementById('addTicker');
const elBtnAdd = document.getElementById('btnAdd');
const elToken = document.getElementById('apiToken');
const elSave = document.getElementById('saveToken');
const elTest = document.getElementById('testConn');
const elTitle = document.getElementById('title');
const elPrice = document.getElementById('price');
const elChart = document.getElementById('chart');
const elTape = document.getElementById('tape');
const elTF = document.getElementById('tf');
const elCtype = document.getElementById('ctype');
const elAlertPrice = document.getElementById('alertPrice');
const elAlertDir = document.getElementById('alertDir');
const elAlertMsg = document.getElementById('alertMsg');

elToken.value = state.token;
elTF.value = state.tf;
elCtype.value = state.ctype;

/* -------- UI: Watchlist -------- */
function renderWatchlist(){
  elWatch.innerHTML = '';
  state.watchlist.forEach(t => {
    const row = document.createElement('div');
    row.style.display='flex'; row.style.gap='8px'; row.style.alignItems='center'; row.style.marginBottom='6px';
    const btn = document.createElement('button');
    btn.className='btn2';
    btn.style.flex='1'; btn.style.textAlign='left';
    btn.style.background = (state.sel===t)?'#111':'#fff';
    btn.style.color = (state.sel===t)?'#fff':'#111';
    btn.textContent = `${t} ${state.prices[t]?'$'+state.prices[t].toFixed(2):''}`;
    btn.onclick = ()=>{ state.sel=t; localStorage.setItem('selected',t); loadCandles(); };
    const del = document.createElement('button');
    del.className='btn2'; del.textContent='✕';
    del.onclick = ()=>{ state.watchlist = state.watchlist.filter(x=>x!==t); saveWL(); };
    row.appendChild(btn); row.appendChild(del);
    elWatch.appendChild(row);
  });
}
function saveWL(){ localStorage.setItem('watchlist', JSON.stringify(state.watchlist)); renderWatchlist(); resubscribe(); }

elBtnAdd.onclick = ()=>{
  const t = (elAdd.value||'').trim().toUpperCase();
  if(!t) return; if(!state.watchlist.includes(t)) state.watchlist.push(t);
  elAdd.value=''; saveWL();
};

/* -------- Settings -------- */
elSave.onclick = ()=>{
  const tok = (elToken.value||'').trim();
  if(!tok) { alert('Paste your Finnhub token first'); return; }
  state.token = tok; localStorage.setItem('finnhub_token', tok);
  connectWS(true); loadCandles(); alert('Token saved locally.');
};
elTest.onclick = async ()=>{
  try{
    const r = await fetch(`https://finnhub.io/api/v1/quote?symbol=AAPL&token=${encodeURIComponent(state.token)}`);
    alert(r.ok ? 'OK! Token works.' : 'Token failed. Check and try again.');
  }catch(e){ alert('Network error.'); }
};
elTF.onchange = ()=>{ state.tf=elTF.value; localStorage.setItem('tf', state.tf); loadCandles(); };
elCtype.onchange = ()=>{ state.ctype=elCtype.value; localStorage.setItem('ctype', state.ctype); loadCandles(); };

/* -------- Alerts -------- */
document.getElementById('btnAlert').onclick = ()=>{
  const p = Number(elAlertPrice.value), d = elAlertDir.value, t = state.sel;
  if(!isFinite(p)) { elAlertMsg.textContent='Enter a number'; return; }
  state.alerts.push({t, p, d}); localStorage.setItem('alerts', JSON.stringify(state.alerts));
  elAlertMsg.textContent = `Alert set: ${t} ${d} $${p}`;
};
function checkAlerts(ticker, price){
  for(const a of state.alerts){
    if(a.t!==ticker) continue;
    if(a.d==='above' && price>=a.p) notify(`${ticker} above $${a.p}`, `Last: $${price.toFixed(2)}`);
    if(a.d==='below' && price<=a.p) notify(`${ticker} below $${a.p}`, `Last: $${price.toFixed(2)}`);
  }
}
function notify(title, body){
  try{
    if (Notification && Notification.permission==='granted'){ new Notification(title, { body }); }
    else if (Notification && Notification.permission!=='denied'){ Notification.requestPermission(); }
  }catch(e){}
  try{ // small beep
    const ctx = new (window.AudioContext||window.webkitAudioContext)();
    const o = ctx.createOscillator(); const g = ctx.createGain();
    o.type='sine'; o.frequency.value=880; o.connect(g); g.connect(ctx.destination);
    o.start(); setTimeout(()=>{ g.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime+0.2); o.stop(); ctx.close(); }, 200);
  }catch(e){}
}

/* -------- Chart -------- */
const chart = LightweightCharts.createChart(elChart, {
  width: elChart.clientWidth, height: 420,
  layout:{background:{type:'Solid',color:'#fff'}, textColor:'#333'},
  grid:{vertLines:{visible:true}, horzLines:{visible:true}},
  rightPriceScale:{borderVisible:false}, timeScale:{borderVisible:false}
});
const series = chart.addCandlestickSeries();
const volSeries = chart.addHistogramSeries({ priceScaleId: '' });
volSeries.priceScale().applyOptions({ scaleMargins: { top: 0.75, bottom: 0 } });
window.addEventListener('resize', ()=> chart.applyOptions({ width: elChart.clientWidth }));

function toHeikin(data){
  const out=[]; for(let i=0;i<data.length;i++){
    const c=data[i]; const close=(c.open+c.high+c.low+c.close)/4;
    const open = i ? (out[i-1].open+out[i-1].close)/2 : (c.open+c.close)/2;
    out.push({time:c.time, open, high:Math.max(c.high,open,close), low:Math.min(c.low,open,close), close, volume:c.volume});
  } return out;
}
function resample(arr, minutes){
  const out=[]; let bucket=null, end=0;
  for(const c of arr){
    if(!bucket || c.time>=end){
      if(bucket) out.push(bucket);
      const start=Math.floor(c.time/60)*60; end=start+minutes*60;
      bucket={time:start,open:c.open,high:c.high,low:c.low,close:c.close,volume:c.volume||0};
    } else {
      bucket.high=Math.max(bucket.high,c.high); bucket.low=Math.min(bucket.low,c.low);
      bucket.close=c.close; bucket.volume += c.volume||0;
    }
  } if(bucket) out.push(bucket); return out;
}
function applyCandles(candles){
  const rows = state.ctype==='heikin' ? toHeikin(candles) : candles;
  series.setData(rows.map(c=>({ time:c.time, open:c.open, high:c.high, low:c.low, close:c.close })));
  volSeries.setData(rows.map(c=>({ time:c.time, value:c.volume||0 })));
}

/* -------- Data load (REST) -------- */
async function loadCandles(){
  const t = state.sel; if(!t || !state.token) { render(); return; }
  elTitle.textContent = t;
  try{
    // 1m base, last ~1000 points
    const r = await fetch(`https://finnhub.io/api/v1/stock/candle?symbol=${encodeURIComponent(t)}&resolution=1&count=1200&token=${encodeURIComponent(state.token)}`);
    const j = await r.json();
    if(j && j.s==='ok'){
      let candles = j.t.map((time,i)=>({ time, open:j.o[i], high:j.h[i], low:j.l[i], close:j.c[i], volume:j.v[i]}));
      const tf = state.tf;
      if (tf==='5m') candles = resample(candles,5);
      else if (tf==='15m') candles = resample(candles,15);
      else if (tf==='1h') candles = resample(candles,60);
      else if (tf==='1D') candles = resample(candles,60*24);
      applyCandles(candles);
    }
  }catch(e){ console.warn('candles err', e); }
  render();
}

/* -------- Live quotes (WS) -------- */
function connectWS(force=false){
  if(!state.token) return;
  if(state.ws && !force) return;
  try{ state.ws && state.ws.close(); }catch(e){}
  state.ws = new WebSocket(`wss://ws.finnhub.io?token=${encodeURIComponent(state.token)}`);
  state.ws.onopen = ()=>{ resubscribe(); };
  state.ws.onmessage = (ev)=>{
    try{
      const msg = JSON.parse(ev.data);
      if(msg.type==='trade'){
        for(const t of msg.data){
          const sym = t.s, price = t.p;
          state.prices[sym] = price;
          if(sym===state.sel) elPrice.textContent = '$'+price.toFixed(2);
          checkAlerts(sym, price);
        }
        render();
      }
    }catch(e){}
  };
  state.ws.onclose = ()=> setTimeout(()=>connectWS(true), 2000);
}
function resubscribe(){
  if(!state.ws || state.ws.readyState!==1) return;
  for(const s of state.subs){ state.ws.send(JSON.stringify({type:'unsubscribe', symbol:s})); }
  state.subs = new Set();
  for(const s of state.watchlist){
    state.ws.send(JSON.stringify({type:'subscribe', symbol:s}));
    state.subs.add(s);
  }
}

/* -------- Render tape/price + init -------- */
function render(){
  elPrice.textContent = state.prices[state.sel] ? '$'+state.prices[state.sel].toFixed(2) : '—';
  elTape.innerHTML='';
  state.watchlist.forEach(t=>{
    const span = document.createElement('span');
    span.innerHTML = `<strong>${t}</strong> ${state.prices[t]?'$'+state.prices[t].toFixed(2):'—'}`;
    elTape.appendChild(span);
  });
  renderWatchlist();
}

window.addEventListener('load', ()=>{
  // Register service worker for PWA install/offline
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('./sw.js');
  }
  if(state.token){ connectWS(); loadCandles(); }
  else { render(); }
});
</script>
</body>
</html>
